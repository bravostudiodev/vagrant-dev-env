{
  "builders": [{
    "name": "win7",
    "vm_name": "win7box",
    "type": "virtualbox-ovf",
    "source_path": "output-win7base/win7basebox.ova",
    "headless": true,
    "boot_wait": "40s",
    "communicator": "winrm",
    "winrm_username": "vagrant",
    "winrm_password": "vagrant",
    "winrm_timeout": "8h",
    "shutdown_command": "shutdown /s /t 10 /f /d p:4:1 /c \"Packer Shutdown\"",
    "shutdown_timeout": "2m",
    "vboxmanage_post": [
      [ "storageattach", "{{.Name}}", "--storagectl", "IDE Controller", "--port", "1", "--device", "0", "--medium", "none" ]
    ],
    "guest_additions_mode": "attach"
  }],
  "provisioners": [{
    "type": "powershell", "elevated_user": "vagrant", "elevated_password": "vagrant", "inline": [
      "Write-Output \"Hotfixes for: (1.)Update is slow and high CPU usage occurs in Windows 7 SP1\"",
      "Write-Output \" https://support.microsoft.com/en-us/kb/3102810\"",
      "Write-Output \"(2.) The OS handle's position is not what FileStream expected (Windows Management Framework 3.0):\"",
      "Write-Output \" http://www.leeholmes.com/blog/2008/07/30/workaround-the-os-handles-position-is-not-what-filestream-expected/\"",
      "(new-object net.webclient).DownloadFile('{{user `HotfixSP1Url`}}', '{{user `HotfixSP1Path`}}')",
      "(new-object net.webclient).DownloadFile('{{user `HotfixPSOSHandleUrl`}}', '{{user `HotfixPSOSHandlePath`}}')",
      "Start-Process -FilePath wusa -ArgumentList '{{user `HotfixSP1Path`}}','/quiet','/norestart' -Wait",
      "Start-Process -FilePath wusa -ArgumentList '{{user `HotfixPSOSHandlePath`}}','/quiet','/norestart' -Wait"
    ]
  },{ 
    "type": "windows-restart" 
  },{
    "type": "powershell", "elevated_user": "vagrant", "elevated_password": "vagrant", "scripts": [
      "scripts/tweaks-basic.ps1",
      "scripts/openssh.ps1",
      "scripts/vb-guest-tools.ps1",
      "scripts/compile-dotnet4.0.30319.ps1"
    ]
  },{
    "type": "windows-restart" 
  }],
  "post-processors": [{
    "type": "vagrant",
    "keep_input_artifact": false,
    "compression_level": 9,
    "vagrantfile_template": "scripts/win7-vagrantfile_template.rb"
  }],
  "variables": {
    "HotfixSP1Url": "https://download.microsoft.com/download/F/A/A/FAABD5C2-4600-45F8-96F1-B25B137E3C87/Windows6.1-KB3102810-x64.msu",
    "HotfixSP1Path": "C:\\Windows\\Temp\\Windows6.1-KB3102810-x64.msu",
    "HotfixPSOSHandleUrl": "http://download.microsoft.com/download/5/2/B/52B59966-3009-4F39-A99E-3732717BBE2A/Windows6.1-KB2506143-x64.msu",
    "HotfixPSOSHandlePath": "C:\\Windows\\Temp\\Windows6.1-KB2506143-x64.msu"
  }
}
